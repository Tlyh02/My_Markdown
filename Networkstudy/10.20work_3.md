

# 第三章 数据链路层

本章重点
1. 数据链路层的**点对点信道**和**广播信道**的特点，以及两种信道使用的协议(**PPP协议**以及**CSMA/CD协议**)的特点
2. 数据链路层的三个基本问题：**封装成帧**、**透明传输**和**差错检测**
3. 以太网MAC层的硬件地址
4. 适配器、转发器、集线器、网桥、以太网交换机的作用以及使用场合
## 3.1 使用点对点信道的数据链路层

### 3.1.1 数据链路和帧

数据链路层把网络层交下来的数据构成帧发送到链路上，以及把接收到的帧中的数据取出并上交给网络层
在互联网中，网络层协议数据单元就是**IP数据报**（或简称为数据报、分组或包)
>
>点对点的数据链路层在进行通信时的主要步骤：
>
>1. 结点A的数据链路层把网络层交下来的P数据报添加首部和尾部封装成帧
>
>2. 结点A把封装好的帧发送给结点B的数据链路层
>
>3. 若结点B的数据链路层收到的帧无差错，则从收到的帧中提取出P数据报交给上面的网络层，否则丢弃这个帧
>
### 3.1.2 三个基本问题
#### 封装成帧
**封装成帧(framing)** 就是在一段数据的前后分别添加首部和尾部，这样就构成了一个帧
一个帧的帧长等于帧的**数据部分长度 （最大传输单元 MTU）**  加上帧首部和帧尾部的长度
首部和尾部的一个重要作用就是进行**帧定界（即确定帧的界限）** 

#### 透明传输
即利用某种手段将MTU中可能出现的控制字符透明化使其不触发控制协议
>
>为了解决透明传输问题，就必须设法使数据中可能出现的控制字符“SOH”和“EOT”在接收端不被解释为控制字符。具体的方法是：发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC”(其十六进制编码是1B,二进制是00011011)。而在接收端的数据链路层在把数据送往网络层之前删除这个插入的转义字符。这种方法称为**字节填充(byte stuffing)** 或**字符填充(character stuffing)** 。如果转义字符也出现在数据当中，那么解决方法仍然是在转义字符的前面插入一个转义字符。因此，当接收端收到连续的两个转义字符时，就删除其中前面的一个。
>
#### 差错控制

1可能会变成0，而0也可能变成1，这就叫做**比特差错**
在一段时间内，传输错误的bit占所传输bit总数的比率为**误码率（EBR）** 
广泛使用的是循环冗余校验（CRC-Cyclic Redundancy Check）
>
>在发送端，先把数据划分为组，假定每组k个比特。现假定待传送的数据M=101001(k=6)。CRC运算就是在数据M的后面添加供差错检测用的n位冗余码，然后构成一个帧发送出去，一共发送(k+n)位。在所要发送的数据后面增加n位的冗余码，虽然增大了数据传输的开销，但却可以进行差错检测。当传输可能出现差错时，付出这种代价往往是很值得的。
这n位冗余码可用以下方法得出。用二进制的模2运算进行2”乘M的运算，这相当于在M后面添加n个0。得到的（k+n)位的数除以收发双方事先商定的长度为(n+1)位的除数P,得出商是Q而余数是R(n位，比P少一位)。关于除数P下面还要介绍。假定除数P=1101(即n=3)。经模2除法运算后的结果是：商Q=110101(这个商并没有什么用处)，而余数R=001。这个余数R就作为冗余码拼接在数据M的后面发送出去。这种为了进行检错而添加的冗余码常称为帧检验序列FCS(Frame Check Sequence)。因此加上FCS后发送的帧是l01001001(即2M+FCS),共有(k+n)位。
>
>
在数据链路层若仅仅使用循环冗余检验CRC差错检测技术，则只能做到对帧的无差错接受，即：“凡是接收端数据链路层接受的帧，我们都能以非常接近于1的概率认为这些帧在传输过程中没有产生差错”，接收端丢弃的帧虽然曾收到了，但最终还是因为有差错被丢弃，即没有被接受，以上所述的可以近似地表述为（通常都是这样认为）：“凡是接收端数据链路层接受的帧均无差错”

## 3.2 点对点协议PPP

### 3.2.1 PPP协议的特点

我们知道，互联网用户通常都要连接到某个ISP才能接入到互联网，PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议

它的特点有：
1. 简单
2. 封装成帧
3. 透明性
4. 多种网络协议
5. 多种类型链路（特别的，PPPoe将PPP帧封装到以太网帧中，让多个用户同时使用一条ISP宽带）
6. 差错检测
7. 检查连接状态
8. 最大传输单元
9. 网络层地址协商
10. 数据压缩协商 

它的组成有：
1. 一个将IP数据报封装到串行链路的方法
2. 一个用来建立、配置和测试数据链路连接的**链路控制协议LCP(Link Control Protocol)**
3. 一套**网络控制协议NCP (Network Control Protocol)**，其中的每一个协议支持不同的网络层协议

### 3.2.2 PPP协议的帧格式

- 各字段的意义

PPP帧的首部和尾部分别为四个字段和两个字段
>
>>F（0x7E）为其始终标志（首部第一个字段和尾部第二个字段）
>>A（0xFF）为首部第二个字段
>>C（0x03）为首部第三个字段
>> 该PPP帧所用协议字段 2字节（0x0021：IP数据报；0xC021：LCP数据；0x8021：网络层控制数据）
>
>上两个字段（A,C）未携带任何信息，仅仅作为PPP帧的格式规定
>
>>MTU（不超过1500字节）
>
>>FCS（CRC校验码）
>>F（0x7E）


- 字节填充

当信息字段中出现和标志字段一样的F(0x7E)组合时，就必须采取一些措施使这种**形式上和标志字段一样的比特**组合不出现在信息字段中。

当PPP使用异步传输时，它把转义符定义为0x7D(即01111101)，并使用字节填充

RFC1662规定了如下所述的填充方法：
>- 把信息字段中出现的每一个0x7E字节转变成为2字节序列(0x7D,0x5E)
>- 若信息字段中出现一个0x7D的字节（即出现了和转义字符一样的比特组合），则把0x7D转变成为2字节序列(0x7D,0x5D)
>- 若信息字段中出现ASCI码的控制字符（即数值小于0x20的字符），则在该字符前面要加入一个0x7D字节，同时将该字符的编码加以改变。例如，出现0x03(在控制字符中是“传输结束”ETX)就要把它转变为2字节序列(0x7D,0x23)

由于在发送端进行了字节填充，因此在链路上传送的信息字节数就超过了原来的信息
字节数。但接收端在收到数据后再进行与发送端字节填充相反的变换，就可以正确地恢复出
原来的信息


- 零比特填充
PPP协议用在SONET/SDH链路时，使用同步传输（一连串的比特连续传送）而不是异步传输（逐个字符地传送），在这种情况下，PPP协议采用零比特填充方法来实现透明传输

>
>零比特填充的具体做法是：**在发送端，先扫描整个信息字段（通常用硬件实现，但也可用软件实现，只是会慢些)。只要发现有5个连续1，则立即填入一个0。接收端在收到一个帧时，先找到标志字段F以确定一个帧的边界，接着再用硬件对其中的比特流进行扫描。每当发现5个连续1时，就把这5个连续1后的一个0删除，以还原成原来的信息比特流。** 
>这样就保证了透明传输：在所传送的数据比特流中可以传送任意组合的比特流，而不会引起对帧边界的错误判断。
>

### 3.2.3 PPP协议的工作状态

PPP链路的起始和终止状态永远是图3-12中的“链路静止”(Link Dead)状态，这时在用户个人电脑和ISP的路由器之间并不存在物理层的连接。当用户个人电脑通过调制解调器呼叫路由器时（通常是在屏幕上用鼠标点击一个连接按钮)，路由器就能够检测到调制解调器发出的载波信号。在双方建立了物理层连接后，PPP就进入“链路建立”(Link Establish)状态，其目的是建立链路层的LCP连接。这时LCP开始协商一些配置选项，发送LCP的配置请求帧(Configure-Request)。这是个PPP帧，其协议字段置为LCP对应的代码，而信息字段包含特定的配置请求。链路的另一端可以发送以下几种响应中的一种：

1. 配置确认帧
2. 配置否认帧
3. 配置拒绝帧

## 使用广播信道的数据链路层

### 3.3.1 局域网的数据链路层

局域网有**网络为一个单位所拥有，且地理范围和站点数目均有限**的特点
此外，局域网还：
1. 具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源
2. 便于系统的扩展和逐渐演变，各设备的位置可灵活调整和改变
3. 提高了系统的可靠性(reliability)、可用性(availability)和生存性(survivability)

### 3.3.2 CSMA/CD协议

CSMA/CD,意思是载波监听多点接入/碰撞检测(Carrier Sense Multiple Access with Collision Detection)

- “多点接入”就是说明这是**总线型网络**，许多计算机以多点接入的方式连接在一根总线上

- “载波监听”就是用电子技术检测**总线上有没有其他计算机也在发送**。载波监听就是检测信道，这是个很重要的措施。不管在发送前，还是在发送中，每个站都必须不停地检测信道。在发送前检测信道，是为了**获得发送权**。如果检测出已经有其他站在发送，则自己就暂时不许发送数据，**必须要等到信道变为空闲时才能发送**。在发送中检测信道，是为了及时发现有没有其他站的发送和本站发送的碰撞。这就称为**碰撞检测**

- “碰撞检测”也就是“边发送边监听”，即适配器**边发送数据边检测**信道上的信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据。当几个站同时在总线上发送数据时，总线上的信号电压变化幅度将会增大（互相叠加）

由此可见，每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。这一小段时间是不确定的，它取决于另一个发送数据的站到本站的距离。因此，以太网不能保证某一时间之内一定能够把自己的数据帧成功地发送出去（因为存在产生碰撞的可能)。以太网的这一特点称为发送的不确定性。如果希望在以太网上发生碰撞的机会很小，必须使整个以太网的平均通信量远小于以太网的最高数据率。

>**凡长度小于64字节的帧都是由于冲突而异常中止的无效帧**

CSMA/CD协议的要点如下：

>1. 准备发送：适配器从网络层获得一个分组，加上以太网的首部和尾部，组成以太网帧，放入适配器的缓存中。但在发送之前，必须先检测信道。
>2. 检测信道：若检测到信道忙，则应不停地检测，一直等待信道转为空闲。若检测到信道空闲，并在96比特时间内信道保持空闲（保证了帧间最小间隔），就发送这个帧。
>3. 在发送过程中仍不停地检测信道，即网络适配器要边发送边监听。
>这里只有两种可能性：
>>①发送成功：在争用期内一直未检测到碰撞。这个帧肯定能够发送成功。发送完毕后，其他什么也不做。然后回到1。
>>②发送失败：在争用期内检测到碰撞。这时立即停止发送数据，并按规定发送人为干扰信号。适配器接着就执行指数退避算法，等待”倍512比特时间后，返回到步骤(2)，继续检测信道。但若重传达16次仍不能成功，则停止重传而向上报错。
>
>以太网每发送完一帧，一定要把己发送的帧暂时保留一下。如果在争用期内检测出发生了碰撞，那么还要在推迟一段时间后再把这个暂时保留的帧重传一次。
>


### 3.3.3 使用集线器的星型拓扑

使用集线器的以太网在逻辑上**仍是一个总线网**，各站共享逻辑上的总线，使用的还是CSMA/CD协议（更具体些说，是各站中的适配器执行CSMA/CD协议）。网络中的各站必须竞争对传输媒体的控制，并且**在同一时刻至多只允许一个站发送数据**。
集线器工作在物理层，它的每个接口**仅仅简单地转发比特**，不进行碰撞检测


### 3.3.4 以太网的信道利用率

假定一个10 Mbit/s以太网同时有10个站在工作，那么每一个站所能发送数据的平均速率似乎应当是总数据率的
1/10（即1Mbit/s）。其实不然，因为多个站在以太网上同时工作就可能会发生碰撞。当发生碰撞时，信道资源实际上是被浪费了。因此，当扣除碰撞所造成的信道损失后，以太网总的信道利用率并不能达到100%。

一个站在发送帧时出现了碰撞。经过一个争用期 2τ后（τ是以太网单程端到端传播时延），可能又出现了碰撞。这样经过若干个争用期后，一个站发送成功了。假定发送帧需要的时间是 $T_{0}$ 。它等于帧长(bit)除以发送速率(10 Mbit/s)。

要提高以太网的信道利用率，就必须减小 τ 与 $T_{0}$ 之比。在以太网中定义了参数a，它是**以太网单程端到端时延τ**与**帧的发送时间 $T_{0}$** 之比：

$$ a={\frac{\tau}{T_{\mathrm{o}}}}$$
-
假定理想化情况下，各站发送数据不会进行碰撞，则每帧占用线路时间为$T_{0}+τ$，而帧发送时间为$T_{0}$，有极限信道利用率$S_{max}$：$$S_{\mathrm{max}}={\frac{T_{0}}{T_{0}+\tau}}={\frac{1}{1+a}}$$


即**只有当参数 a 远小于 1 才能得到尽可能高的极限信道利用率**


### 3.3.5 以太网的MAC层

- MAC层的硬件地址
严格地讲，局域网的“地址”应当是每一个站的“名字”或标识符[PERL00]
适配器有过滤功能，会对每一个MAC帧做检验
>1.单播(unicast)帧（一对一），即收到的帧的 MAC 地址与本站的硬件地址相同。
>2. 广播(broadcast)帧（一对全体），即发送给本局域网上所有站点的帧（全１地址）。
>3. 多播(multicast)帧（一对多），即发送给本局域网上一部分站点的帧。

>以太网适配器还可设置为一种特殊的工作方式，即混杂方式(promiscuous mode)。工作
在混杂方式的适配器只要“听到”有帧在以太网上传输就都悄悄地接收下来，而不管这些帧
是发往哪个站。
>

- MAC帧的格式
MAC帧有两种格式
>1. DIX Ethernet V2 标准（即以太网 V2 标准）
>2. IEEE的802.3标准

这里只说明以太网V2标准
>以太网 V2 的 MAC 帧较为简单，由五个字段组成。
>前两个字段分别为 6 字节长的目的地址和源地址字段。
>第三个字段是2字节的类型字段，用来标志上一层使用的是什么协议,以便把收到的 MAC 帧的数据上交给上一层的这个协议。例如，当类型字段的值是 0x0800时，就表示上层使用的是 IP数据报。若类型字段的值为0x8137，则表示该帧是由 NovellIPX发过来的。第四个字段是数据字段，其长度在 46 到1500字节之间（46字节是这样得出的：最小长度 64 字节减去18字节的首部和尾部就得出数据字段的最小长度）。
>最后一个字段是 4 字节的帧检验序列 FCS（使用 CRC 检验）。当传输媒体的误码率为 1 E-8时,MAC子层可使未检测到的差错小于1E-14。
>

## 3.4 拓展的以太网

在许多情况下，我们希望对以太网的覆盖范围进行扩展。本节先讨论在物理层对以太网扩展，然后讨论在数据链路层对以太网扩展。**这种扩展的以太网络层看来仍然是一个网络**

### 3.4.1 在物理层拓展以太网

以太网上的主机之间的距离**不能太远**（例如，10BASE-T 以太网的两台主机之间的距离**不超过 200 米**），否则主机发送的信号经过铜线的传输就会**衰减到使 CSMA/CD 协议无法正常工作**。在过去广泛使用粗缆或细缆以太网时，常使用工作在物理层的转发器来扩展以太网的地理覆盖范围。
那时，两个网段可用一个转发器连接起来。IEEE 802.3 标准还规定，任意两个站之间最多可以经过三个电缆网段。但随着双绞线以太网成为以太网的主流类型，扩展以太网的覆盖范围已很少使用转发器了。
现在，扩展主机和集线器之间的距简单方法就是使用光纤（通常是一对光纤）和一对光纤调制解调器。
- 但是多级结构有几种问题
>1.  当某个次级集线器的两个站在通信时所传送的数据会通过所有的集线器进行转发，使得其他次级集线器的内部在这时都不能通信（一发送数据就会碰撞）。
>2. 如果不同的次级集线器使用不同的以太网技术（如数据率不同），那么就不可能用总集线器将它们互连起来。如果一个次级集线器使用 10 Mbit/s 的适配器，而另外两个次级集线器使用10/100 Mbit/s 的适配器，那么用总集线器连接起来后，大家都只能工作在 10 Mbit/s 的速率。
集线器基本上是个多接口（即多端口）的转发器，它并不能把帧进行缓存。
>
### 3.4.2 在数据链路层拓展以太网 

扩展以太网更常用的方法是在数据链路层进行。
最初人们使用的是**网桥(bridge)**。网桥对收到的帧根据其MAC帧的目的地址进行转发和过滤。当网桥收到一个帧时，并不是向所有的接口转发此项，而是根据此项的目的MAC地址找地址表，然后确定将诊帧转发到哪一个接口，或者是把它丢弃（即过滤）。
1990年问世的**交换式集线器(switching hub)**，很快就淘汰了网桥。交换式集线器常称为**以太网交换机(switch)**或**第二层交换机(L2 switch)**，强调这种交换机工作在数据链路层。

以太网交换机的特点：
>以太网交换机的接口有存储器，能在输出端口繁忙时把到来的帧进行缓存。因此，如果连接在以太网交换机上的两台主机，同时向另一台主机发送帧，那么当这台主机的接口繁忙时，发送帧的这两台主机的接口会把收到的帧暂存一下，以后再发送出去。以太网交换机是一种即插即用设备，其内部的帧交换表（又称为地址表）是通过自学习算法自动地逐渐建立起来的。以太网交换机由于使用了专用的交换结构芯片，用硬件转发，其转发速率要比使用软件转发的网桥快很多。以太网交换机的性能远远超过普通的集线器，而且价格并不贵，这就使工作在物理层的集线器逐渐地退出了市场。
>
以太网还有自学习功能，以太网交换机通过自学习功能做到接口的热插拔功能：
>
>- A先向B发送一帧，从接口1进入到交换机。
>- 交换机收到帧后，先查找交换表，没有查到应从哪个接口转发这个帧（在MAC地址这一列中，找不到目的地址为B的项目）。
>- 接着，交换机把这个帧的源地址A和接口1写入交换表中，并向除接口1以外的所有接口广播这个帧（这个帧就是从接口1进来的，当然不应当把它再从接口1转发出去）。
>- C和D将丢弃这个帧，因为目的地址不对。
>- 只有B才收下这个目的地址正确的帧，这也称为过滤。从新写入交换表的项目(A,1)可以看出，以后不管从哪一个接口收到帧，只要其目的地址是A,就应当把收到的帧从接口1转发出去。
>- 这样做的依据是：既然A发出的帧是从接口1进入到交换机的，那么从交换机的接口1转发出的帧也应当可以到达A。假定接下来B通过接口3向A发送一帧。交换机查找交换表，发现交换表中的MAC地址有A。表明要发送给A的帧（即目的地址为A的帧）应从接口1转发。于是就把这个帧传送到接口1转发给A。显然，现在己经没有必要再广播收到的帧。
>- 交换表这时新增加的项目(B,3),表明今后如有发送给B的帧，就应当从接口3转发出去。
>- 经过一段时间后，只要主机C和D也向其他主机发送帧，以太网交换机中的交换表就会把转发到C或D应当经过的接口号(2或4)写入到交换表中。这样，交换表中的项目就齐全了。
>- 要转发给任何一台主机的帧，都能够很快地在交换表中找到相应的转发接口。考虑到有时可能要在交换机的接口更换主机，或者主机要更换其网络适配器，这就需要更改交换表中的项目。为此，在交换表中每个项目都设有一定的有效时间。过期的项目就自动被删除。用这样的方法保证交换表中的数据都符合当前网络的实际状况。
>

有时，使用以太网交换机组网时，会造成环路，在IEEE802.1D标准中制定了STP生成树协议以避免这一情况


### 3.4.3 虚拟局域网

利用以太网交换机可以很方便地实现**虚拟局域网VLAN(Virtual LAN)**。
在 IEEE 802.1Q 标准中，对虚拟局域网VLAN是这样定义的：

虚拟局域网VLAN是由一些局域网网段构成的与物理位置无关的逻辑组，而这些网段具有某些共同的需求。每一个VLAN的帧都有一个明确的标识符，指明发送这个帧的计算机属于哪一个VLAN。

虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网。

## 高速以太网

### 100BASE-T以太网

100BASE-T是在双绞线上传送**100Mbit/s基带信号**的星形拓扑以太网，仍**使用IEEE802.3的CSMA/CD协议**，它又称为**快速以太网（Fast Ethernet）**。用户只要使用**100Mbit/s的适配器**和**100Mbit/s的集线器或交换机**，就可很方便地由10BASE-T以太网直接升级到100Mbit/s,而不必改变网络的拓扑结构。所有在10BASE-T上的应用软件和网络软件都可保持不变，其适配器可自动识别10Mbit/s与100MBit/s。

### GBit网

吉比特以太网的产品已在1996年夏季问市。IEEE在1997年通过了吉比特以太网的标准802.3z,并在1998年成为正式标准。
吉比特以太网的标准EEE802.3z有以下几个特点：
1. 允许在1Gbts下以全双工和半双工两种方式工作。
2. 使用IEEE802.3协议规定的帧格式。
3. 在半双工方式下使用CSMA/CD协议，而在全双工方式不使用CSMA/CD协议。
4. 与10BASE-T和100BASE-T技术向后兼容。

### 10GBit和更快的以太网

10GE的帧格式与10 Mbit/s,100Mbit/s和1Gbit/s以太网的**帧格式完全相同**，并保留了802.3标准规定的以太网最小帧长和最大帧长。这就使用户在将其已有的以太网进行升级时，仍能和较低速率的以太网很方便地通信。
10GE**只工作在全双工方式**，因此不存在争用问题，当然也不使用CSMA/CD协议。这就使得10GE的传输距离大大提高了（因为不再受必须进行碰撞检测的限制）。


### 用以太网进行宽带接入

把PPP协议中的PPP帧再封装到以太网中来传输。这就是l999年公布的PPPoE (PPP over Ethernet),意思是“在以太网上运行PPP”[RFC2516]。现在的光纤宽带接入FTTx都要使用PPPoE的方式进行接入。

例如，如果使用光纤到大楼FTTB的方案，就在每个大楼的楼口安装一个光网络单元ONU(实际上就是一个以太网交换机)，然后根据用户所申请的带宽，用5类线（请注意，到这个地方，传输媒体已经变为铜线了)接到用户家中。如果大楼里上网的用户很多，那么还可以在每一个楼层再安装一个100 Mbit/s的以太网交换机。各大楼的以太网交换机通过光缆汇接到光结点汇接点（光汇接点一般通过城域网连接到互联网的主干网）。
使用这种方式接入到互联网时，在用户家中不再需要使用任何调制解调器。用户家中只有一个RJ45的插口。用户把自己的个人电脑通过5类网线连接到墙上的RJ-45插口中，然后在PPPoE弹出的窗口中键入在网络运营商处购买的用户名（就是一串数字）和密码，就可以进行宽带上网了。
请注意，使用这种以太网宽带接入时，从用户家中的个人电脑到户外的第一个以太网交换机的带宽是能够得到保证的。因为这个带宽是用户独占的，没有和其他用户共享。但这个以太网交换机到上一级的交换机的带宽，是许多用户共享的。因此，如果过多的用户同时上网，则有可能使每一个用户实际上享受到的带宽减少。这时，网络运营商就应当及时进行扩容，以保证用户的利益不受损伤。

顺便指出，当用户利用ADSL(非对称数字用户线)进行宽带上网时，从用户个人电脑到家中的ADSL调制解调器之间，也是使用RJ45和5类线（即以太网使用的网线）进行连接的，并且也是使用PPPoE弹出的窗口进行拨号连接的。

但是用户个人电脑发送的以太网帧到了家里的ADSL调制解调器后，就转换成为ADSL使用的PPP帧。需要注意的是，在用户家中墙上是通过电话使用的RJ-11插口，用普通的电话线传送PPP帧。这己经和以太网没有关系了。所以这种上网方式不能称为以太网上网，而是利用电话线宽带接入到互联网。
<!--stackedit_data:
eyJoaXN0b3J5IjpbNDE4NjAzMzY5XX0=
-->