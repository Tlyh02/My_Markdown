
# 第四章 网络层
本章最重要的内容：
- **虚拟互连网络**的概念。
- IP地址与物理地址的关系。
- 传统的**分类的IP地址（包括子网掩码）** 和 **无分类域间路由选择CDR**。
- **路由选择协议**的工作原理。

## 4.1 网络层提供的两种服务
- 网络层向上只提供**简单灵活的、无连接的、尽最大努力交付**的数据报服务。
- 网络层**不提供**服务质量的承诺。

## 4.2 网际协议IP
网际协议IP是TCP/IP体系中两个**最重要**的协议之一，也是最重要的互联网标准。
有其他三个协议配套使用：
- 地址解析协议 ARP
- 网际控制报文协议 ICMP
- 网际组管理协议 IGMP


### 4.2.1 虚拟互联网络
因为世界上的网络是多种多样的，没有一种特别单一的网络能够适应所有用户的需求，所以需要一些中间设备进行互连形成一个**虚拟互联网络**，使得这些网络看上去好像是一个统一的网络。互联网可以**由多种异构网络**互连完成。

### 4.2.2 分类的IP地址

1. IP地址及其表示方法
整个的互联网就是一个单一的、抽象的网络。IP地址就是给互联网上的**每一台**主机(或路由器)的**每一个**接口分配一个在全世界范围内是**唯一的32位的**标识符。IP地址的结构使我们可以在互联网上很方便地进行寻址。IP地址现在由互联网名字和数字分配机构ICANN(Internet Corporation for Assigned Names and Numbers)进行分配。
一个IP地址在整个互联网范围内是唯一的，这种两级的IP地址可以记为：
- **IP地址 定义为  {<网络号>,<主机号>}** 

---
- A类、B类和C类地址的网络号字段分别为1个、2个和3个字节长，而在网络号字段的最前面有1~3位的类别位，其数值分别规定为0,10和110。
- A类、B类和C类地址的主机号字段分别为3个、2个和1个字节长。
- D类地址（前4位是1110）用于多播（一对多通信）。
- E类地址（前4位是1111）保留为以后用。
2. 常用的三种类别的IP地址
- A类地址的主机号占3个字节，因此每一个A类网络中的最大主机数是224-2，即16777214。这里减2的原因是：全0的主机号字段表示该P地址是“本主机”所连接到的单个网络地址（例如，一主机的IP地址为5.6.7.8，则该主机所在的网络地址就是5.0.0.0)，而全1表示“所有的(al)”,因此全1的主机号字段表示该网络上的所有主机。**IP地址空间共有2 ^ 32（即4294967296）个地址**。整个A类地址空间共有2 ^ 31个地址，占整个IP地址空间的50%。
- B类地址的网络号字段有2个字节，但前面两位（10)已经固定了，只剩下14位可以进行分配。因为网络号字段后面的14位无论怎样取值也不可能出现使整个2字节的网络号字段成为全0或全1，因此这里不存在网络总数减2的问题。但实际上B类网络地址128.0.0.0是不指派的，而可以指派的B类最小网络地址是128.1.0.0「COME061。因此B类地址可指派的网络数为214-1，即16383。B类地址的每一个网络上的**最大主机数是2 ^ 62,即65534**。这里需要减2是因为要扣除全0和全1的主机号。整个B类地址空间共约有230个地址，占整个IP地址空间的25%。
- C类地址有3个字节的网络号字段，最前面的3位是(110)，还有21位可以进行分配。C类网络地址192.0.0.0也是不指派的，可以指派的C类最小网络地址是192.0.1.0[C0ME06],因此C类地址**可指派的网络总数是2 ^ 21-1，即2097151**。每一个C类地址的**最大主机数是2 ^ 8-2，即254**。整个C类地址空间共约有229个地址，占整个P地址的12.5%。

### 4.2.3 IP地址和硬件地址
在学习IP地址时，很重要的一点就是要弄懂主机的IP地址与硬件地址的区别。从层次的角度看，**物理地址是数据链路层和物理层使用的地址，而IP地址是网络层和以上各层使用的地址**，是一种逻辑地址（称IP地址为逻辑地址是因为IP地址是用软件实现的)。
- 在IP层抽象的互联网上只能看到**IP数据报**。
- 虽然在IP数据报首部有源站IP地址，但路由器**只根据目的站的IP地址的网络号**进行路由选择。
- 在局域网的**链路层**，**只能看见**MAC帧。

### 4.2.4 地址解析协议ARP
IP地址和下面的网络的硬件地址之间由于格式不同而不存在简单的映射关系。此外，在一个网络上可能经常会有新的主机加入进来，或撤走一些主机。更换网络适配器也会使主机的硬件地址改变。**地址解析协议ARP**解决这个问题的方法是在**主机ARP高速缓存**中存放一个从IP地址到硬件地址的映射表，并且这个映射表还经常动态更新（新增或超时删除）。每一台主机都设有一个**ARP高速缓存(ARP cache)**,里面有**本局域网上的各主机和路由器的IP地址到硬件地址的映射表**，这些都是该主机目前知道的一些地址。
如何进行ARP：
1. ARP进程在本局域网上广播发送一个ARP请求分组

2. 在本局域网上的所有主机上运行的ARP进程都收到此ARP请求分组

3. 主机B的IP地址与ARP请求分组中要查询的IP地址一致，就收下ARP请求分组，并向A发送ARP响应分组

4. A拿到B的ARP响应分组后，就在其ARP高速缓存中写入B的IP地址到硬件地址的映射

5. 当生存时间到后重新A重新进行ARP进程


### 4.2.5 IP数据报的格式
1. IP数据报首部的固定部分中的各字段
>
>- 版本——4位 IPv4 or IPv6
>- 首部长度——4位 
>- 区分服务——8位 一般不使用
>- 总长度———16位
>- 标识————16位
>- 标志————3位 用于标识分片结束（MF=1/0）/用于标识是否允许分片（DF=1/0）
>- 片偏移———13位 标识分片位于元数据报起点向后偏移何处，以8字节为偏移单位
>- 生存时间——8位 防止无限回环
>- 协议———— 8位 指出数据报所使用的协议
>- 首部检验和—16位 只检验数据报的首部，不包括数据部分
>- 源地址———32位
>- 目的地址——32位



2. IP数据报首部的可变部分

IP数据报首部的可变部分就是一个选项字段。选项字段用来支持排错、测量以及安全等措施，内容很丰富。此字段的长度可变，从1个字节到40个字节不等，取决于所选择的项目。某些选项项目只需要1个字节，它只包括1个字节的选项代码。而有些选项需要多个字节，这些选项一个个拼接起来，中间不需要有分隔符，最后用全0的填充字段补齐成为4字节的整数倍。增加首部的可变部分是为了增加IP数据报的功能，但这同时也使得IP数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。实际上这些选项很少被使用。很多路由器都不考虑IP首部的选项字段，因此新的IP版本IPv6就把IP数据报的首部长度做成固定的。

### 4.2.6 IP层转发分组的流程
>1. 从数据报的首部提取目的主机的IP地址D,得出目的网络地址为N。
>2. 若N就是与此路由器直接相连的某个网络地址，则进行直接交付，不需要再经过其他的路由器，直接把数据报交付目的主机（这里包括把目的主机地址D转换为具体的硬件地址，把数据报封装为MAC帧，再发送此帧)；否则就是间接交付，执行3。
>3. 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)。
>4. 若路由表中有到达网络N的路由，侧把数据报传送给路由表中所指明的下一跳路由器；否则，执行(5)。
>5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)。
>6. 报告转发分组出错。

## 4.3 划分子网和构造超网
在阿帕网早期，IP地址的设计确实不够合理。
1. IP地址空间的利用率有时很低
每一个A类地址网络可连接的主机数超过1000万，而每一个B类地址网络可连接的主机数也超过6万。有的单位申请到了一个B类地址网络，但所连接的主机数并不多，可是又不愿意申请一个足够使用的C类地址，理由是考虑到今后可能的发展。IP地址的浪费，还会使IP地址空间的资源过早地被用完。
2. 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏
每一个路由器都应当能够从路由表查出应怎样到达其他网络的下一跳路由器。因此，互联网中的网络数越多，路由器的路由表的项目数也就越多。这样，即使我们拥有足够多的P地址资源可以给每一个物理网络分配一个网络号，也会导致路由器的路由表中的项目数过多。这不仅增加了路由器的成本（需要更多的存储空间），而且使查找路由时耗费更多的时间，同时也使路由器之间定期交换的路由信息急剧增加，因而使路由器和整个互联网的性能都下降了。
3. 两级IP地址不够灵活
有时情况紧急，一个单位需要在新的地点马上开通一个新的网络。但是在申请到一个新的IP地址之前，新增加的网络是不可能连接到互联网上工作的。我们希望有一种方法，使一个单位能随时灵活地增加本单位的网络，而不必事先到互联网管理机构去申请新的网络号。原来的两级IP地址无法做到这一点。

### 4.3.1 划分子网
为解决上述问题，从1985年起在IP地址中又增加了一个“子网号字段”，使两级IP地址变成为三级IP地址，它能够较好地解决上述问题，并且使用起来也很灵活。这种做法叫做**划分子网(subnetting),子网寻址或子网路由选择**。划分子网己成为互联网的正式标准协议。
1. 划分子网的基本思路：
>1. 一个拥有许多物理网络的单位，可将所属的物理网络划分为若干个子网(subnet)。划分子网纯属一个单位内部的事情。本单位以外的网络看不见这个网络是由多少个子网组成，因为这个单位对外仍然表现为一个网络。
>
>2. 划分子网的方法是从网络的主机号借用若干位作为子网号(subnet--id),于是两级IP地址在本单位内部就变为三级IP地址：网络号、子网号和主机号。也可以用以下记法来表示：
>
>**P地址 定义为 {<网络号>，<子网号>，<主机号>}**
>
>3. 凡是从其他网络发送给本单位某台主机的IP数据报，仍然是根据IP数据报的目的网络号找到连接在本单位网络上的路由器。但此路由器在收到IP数据报后，再按目的网络号和子网号找到目的子网，把IP数据报交付目的主机。

2. 子网掩码
把三级IP地址的**子网掩码和收到的数据报的目的IP地址逐位相 “与”(AND)**，可以得出所要找的子网的网络地址。
如果一个网络不划分子网，那么该网络的子网掩码就使用 **默认子网掩码**。
划分子网增加了灵活性，但却**减少了能够连接在网络上的主机总数**。

### 4.3.2 使用子网时分组的转发
1. 从收到的数据报的首部提取目的IP地址D。
1. 先判断是否为直接交付。对路由器直接相连的网络逐个进行检查：用各网络的子网掩码和D逐位相“与”(AND操作)，看结果是否和相应的网络地址匹配。若匹配，则把分组进行直接交付（当然还需要把D转换成物理地址，把数据报封装成帧发送出去），转发任务结束。否则就是间接交付，执行(3)。
1. 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)。
1. 对路由表中的每一行（目的网络地址，子网掩码，下一跳地址)，用其中的子网掩码和D逐位相“与”（AND操作)，结果为N。若N与该行的目的网络地址匹配，则把数据报传送给该行指明的下一跳路由器；否则，执行（5）。
1. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)。
1. 报告转发分组出错。


### 4.3.3 无分类编址CIDR（构造超网）
1. 网络前缀

- CDR消除了传统的A类、B类和C类地址以及划分子网的概念，因而能更加有效地分配IPv4的地址空间CDR使P地址从三级编址(使用子网掩码)又回到了两级编址，但这己是无分类的两级编址。其记法是：

>IP地址：={<网络前缀>，<主机号>}

- CIDR还使用“斜线记法”(slash notation),或称为CDR记法，即在IP地址后面加上斜线“/”，然后写上网络前缀所占的位数。

- CIDR把网络前缀都相同的连续的P地址组成一个“CIDR地址块”。我们只要知道CDR地址块中的任何一个地址，就可以知道这个地址块的起始地址（即最小地址)和最大地址，以及地址块中的地址数。

2. 最长前缀匹配
    在使用CDR时，由于采用了网络前缀这种记法，P地址由网络前缀和主机号这两个部分组成，因此在路由表中的项目也要有相应的改变。这时，每个项目由“网络前缀”和“下一跳地址”组成。但是在查找路由表时可能会得到不止一个匹配结果。这样就带来一个问题：我们应当从这些匹配结果中选择哪一条路由呢？正确的答案是：应当从匹配结果中选择具有最长网络前缀的路由。这叫做最长前缀匹配(longest--prefix matching),这是因为网络前缀越长，其地址块就越小，因而路由就越具体(more specific)。最长前缀匹配又称为最长匹配或最佳匹配。为了说明最长前缀匹配的概念，我们仍以前面的例子来讨论。
    
3. 使用二叉线索查找路由表


## 4.4 网际控制报文协议ICMP
为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了**网际控制报文协议ICMP(Internet Control Message Protocol)**
### 4.4.1 ICMP报文的种类
ICMP报文的种类有两种，即ICMP差错报告报文和ICMP询问报文。
ICMP差错报文有：
1. 终点不可达
当路由器或主机不能交付数据报时就向源点发送终点不可达报文。
2. 时间超过
当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把己收到的数据报片都丢弃，并向源点发送时间超过报文。
3. 参数问题
当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
4. 改变路由（重定向）
路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。

ICMP询问报文有：
1. 回送请求和回答
ICMP回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态。
2. 时间戳请求和回答
ICMP时间戳请求报文是请某台主机或路由器回答当前的日期和时间。在ICMP时间戳回答报文中有一个32位的字段，其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒。时间戳请求与回答可用于时钟同步和时间测量。
### 4.4.2 ICMP的应用举例
ICMP的一个重要应用就是分组网间探测PING(Packet InterNet Groper),用来测试两台主机之间的连通性。PNG使用了ICMP回送请求与回送回答报文。PNG是应用层直接使用网络层ICMP的一个例子。

另一个非常有用的应用是traceroute(这是UNIX操作系统中名字)，它用来跟踪一个分组从源点到终点的路径。在Windows操作系统中这个命令是tracert。


## 4.5 互联网的路由选择协议

### 4.5.1 有关路由选择协议的几个基本概念

1. **算法必须是正确的和完整的。** 这里，“正确”的含义是：沿着各路由表所指引的路由，分组一定能够最终到达目的网络和目的主机。
2. **算法在计算上应简单。** 路由选择的计算不应使网络通信量增加太多的额外开销。
3. **算法应能适应通信量和网络拓扑的变化** ，这就是说，要有自适应性。当网络中的通信量发生变化时，算法能自适应地改变路由以均衡各链路的负载。当某个或某些结点、链路发生故障不能工作，或者修理好了再投入运行时，算法也能及时地改变路由。有时称这种自适应性为“稳健性”(robustness)。
4. **算法应具有稳定性。** 在网络通信量和网络拓扑相对稳定的情况下，路由算法应收敛于一个可以接受的解，而不应使得出的路由不停地变化。
5. **算法应是公平的。** 路由选择算法应对所有用户（除对少数优先级高的用户）都是平等的。例如，若仅仅使某一对用户的端到端时延为最小，但却不考虑其他的广大用户，这就明显地不符合公平性的要求。
6. **算法应是最佳的。** 路由选择算法应当能够找出最好的路由，使得分组平均时延最小而网络的吞吐量最大。虽然我们希望得到“最佳”的算法，但这并不总是最重要的。对于某


### 4.5.2 内部网关协议RIP
RIP(Routing Information Protocol)是内部网关协议IGP中最先得到广泛使用的协议，它的中文名称叫做路由信息协议，但很少被使用。RIP是一种分布式的基于距离向量的路由选择协议，是互联网的标准协议，其最大优点就是简单。RIP协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录（因此，这是一组距离，即“距离向量”）。


### 4.5.3 内部网关协议OSPF
这个协议的名字是开放最短路径优先OSPF(Open Shortest Path First)。它是为克服RIP的缺点在1989年开发出来的。OSPF的原理很简单，但实现起来却较复杂。“开放”表明OSPF协议不是受某一家厂商控制，而是公开发表的。“最短路径优先”是因为使用了Dijkstra提出的最短路径算法SPF。OSPF的第二个版本OSPF2己成为互联网标准协议RFC2328。


### 4.5.4 外部网关协议BGP
1989年，公布了外部网关协议一边界网关协议BGP。最近已经陆续发布了一些BGP-4的更新文档，但目前BGP-4仍然是草案标准[RFC4271]。


## 4.6 IPv6

### 4.6.1 IPv6的基本首部
**IPv6所引进的主要变化如下：**
1. 更大的地址空间。IPv6把地址从IPv4的32位增大到4倍，即增大到128位，使地址空间增大了26倍。这样大的地址空间在可预见的将来是不会用完的。
2. 扩展的地址层次结构。IPv6由于地址空间很大，因此可以划分为更多的层次。
3. 灵活的首部格式。IPv6数据报的首部和Pv4的并不兼容。IPv6定义了许多可选的扩展首部，不仅可提供比IPV4更多的功能，而且还可提高路由器的处理效率，这是因为路由器对扩展首部不进行处理（除逐跳扩展首部外）。
4. 改进的选项。IPv6允许数据报包含有选项的控制信息，因而可以包含一些新的选项。但IPV6的首部长度是固定的，其选项放在有效载荷中。我们知道，IPV4所规定的选项是固定不变的，其选项放在首部的可变部分。
5. 允许协议继续扩充。这一点很重要，因为技术总是在不断地发展（如网络硬件的更新)而新的应用也还会出现。但我们知道，IPv4的功能是固定不变的。
6. 支持即插即用（即自动配置）。因此IPv6不需要使用DHCP。
7. 支持资源的预分配。IPV6支持实时视像等要求保证一定的带宽和时延的应用。
8. IPv6首部改为8字节对齐（即首部长度必须是8字节的整数倍）。原来的IPv4首部是4字节对齐。


**与Pv4相比，Pv6对首部中的某些字段进行了如下的更改：**
- 取消了首部长度字段，因为它的首部长度是固定的(40字节)。
- 取消了服务类型字段，因为优先级和流标号字段实现了服务类型字段的功能。
- 取消了总长度字段，改用有效载荷长度字段。
- 取消了标识、标志和片偏移字段，因为这些功能已包含在分片扩展首部中。
- 把TTL字段改称为跳数限制字段，但作用是一样的（名称与作用更加一致）。
- 取消了协议字段，改用下一个首部字段。
- 取消了检验和字段，这样就加快了路由器处理数据报的速度。我们知道，在数据链路层对检测出有差错的帧就丢弃。在运输层，当使用UDP时，若检测出有差错的用户数据报就丢弃。当使用TCP时，对检测出有差错的报文段就重传，直到正确传送到目的进程为止。因此在网络层的差错检测可以精简掉。
- 取消了选项字段，而用扩展首部来实现选项功能。

ipv6各字段作用：
(1)版本(version)
(2)通信量类(traffic class)
(3)流标号(flow label)
(4)有效载荷长度(payload length)
(5)下一个首部(next header)
(6)跳数限制(hop limit)
(7)源地址
(8)目的地址

### 4.6.2 IPv6的地址
一般来讲，一个PV6数据报的目的地址可以是以下三种基本类型地址之一：
- 单播(unicast)
单播就是传统的点对点通信。
- 多播(multicast)
多播是一点对多点的通信，数据报发送到一组计算机中的每一个。Pv6没有采用广播的术语，而是将广播看作多播的一个特例。
- 任播(anycast)
这是PV6增加的一种类型。任播的终点是一组计算机，但数据报只交付其中的一个，通常是距离最近的一个。


### 4.6.3 IPv4 向 IPv6 过度
1. 双协议栈
双协议栈(dual stack)是指在完全过渡到IPv6之前，使一部分主机（或路由器）装有双协议栈：一个IPv4和一个IPv6。因此双协议栈主机（或路由器）既能够和IPv6的系统通信，又能够和IPv4的系统通信。双协议栈的主机（或路由器）记为IPv6/IPv4,表明它同时具有两种P地址：一个IPv6地址和一个IPv4地址。
2. 隧道技术
这种方法的要点就是在IPv6数据报要进入Pv4网络时，把IPv6数据报封装成为IPv4数据报。整个的IPv6数据报变成了IPv4数据报的数据部分。


### 4.6.4 ICMPv6 

## 4.7 IP多播

### 4.7.1 IP多播的基本概念

### 4.7.2 在局域网上进行硬件多播

### 4.7.3 网际组管理协议IGMP和多播路由选择协议

## 4.8 虚拟专用网 VPN 和网络地址转换 NAT

### 4.8.1 虚拟专用网VPN 
利用公用的互联网作为机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网VPN(Virtual Private Network)。“虚拟”表示“好像是”，但实际上并不是，因为现在并没有真正使用通信专线，而VPN只是在效果上和真正的专用网一样。
有时一个机构的VPN需要有某些外部机构（通常就是合作伙伴）参加进来。这样的VPN就称为外联网(extranet或extranet VPN,即外联网VPN)。
### 4.8.2 网络地址转换NAT
- 网络地址转换NAT (Network Address Translation)方法是在l994年提出的。这种方法需要在专用网连接到互联网的路由器上安装NAT软件。装有NAT软件的路由器叫做NAT路由器，它至少有一个有效的外部全球IP地址。这样，所有使用本地地址的主机在和外界通信时，都要在AT路由器上将其本地地址转换成全球IP地址，才能和互联网连接。
- 由此可见，当NAT路由器具有n个全球IP地址时，专用网内最多可以同时有n台主机接入到互联网。这样就可以使专用网内较多数量的主机，轮流使用NAT路由器有限数量的全球IP地址。
- 使用端口号的NAT也叫做网络地址与端口号转换NAPT (Network Address and PortTranslation),而不使用端口号的NAT就叫做传统的NAT(traditional NAT)。



<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE4Njk0ODU1NDUsLTIwMDcwNjEzODUsLT
E2ODY4ODAwMDUsMTA4Mjk5MDE1NiwtMTM5NjQwOTYwMCwtNjYw
MDk0NTMxLC0xMzk3NzEwNjAxLDEwMjUwOTY0NDksMTU5Mzk2Nj
M0MywxMDE4ODY5NzEzLDM1NDk0MzYzNywtOTE5Njk5NDM1LDEz
MjEwNTA2MjQsMTEwODUxOTExOCwxMTA0MzcyMjM2LC02MDg5MD
c5ODUsMTQzNTU3OTczOCw3NDg3MDM0MzUsLTkxNDI1Mjg5Mywx
OTQ2NDEyMzQ1XX0=
-->